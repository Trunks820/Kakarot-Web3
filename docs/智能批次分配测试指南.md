# æ™ºèƒ½æ‰¹æ¬¡åˆ†é…æµ‹è¯•æŒ‡å—

## ğŸ“‹ æµ‹è¯•å‰å‡†å¤‡

### 1. ç¡®è®¤æ•°æ®åº“å·²æ›´æ–°
```sql
-- æ£€æŸ¥è¡¨ç»“æ„æ˜¯å¦åŒ…å«æ–°å­—æ®µ
DESC monitor_batch_v2;  -- åº”è¯¥æœ‰ consumer_id, epoch, target_count, archived_time
DESC monitor_task_v2;   -- åº”è¯¥æœ‰ current_epoch
DESC monitor_task_target_v2; -- åº”è¯¥æœ‰ id, task_id, ca, chain_type, status

-- æ£€æŸ¥å”¯ä¸€ç´¢å¼•
SHOW INDEX FROM monitor_task_target_v2; -- åº”è¯¥æœ‰ ux_target_task_ca
```

### 2. å‡†å¤‡æµ‹è¯•æ•°æ®
```sql
-- 1. åˆ›å»ºæµ‹è¯•ä»»åŠ¡
INSERT INTO monitor_task_v2 (task_name, task_type, chain_type, status, create_time)
VALUES ('æµ‹è¯•æ™ºèƒ½ä»»åŠ¡', 'smart', 'sol', 1, NOW());

-- è·å–ä»»åŠ¡IDï¼ˆå‡è®¾æ˜¯ 100ï¼‰
SELECT LAST_INSERT_ID();

-- 2. ç¡®ä¿ token_launch_history æœ‰æµ‹è¯•æ•°æ®
SELECT COUNT(*) FROM token_launch_history WHERE chain_type = 'sol';
```

### 3. å¯åŠ¨åº”ç”¨
- åœ¨IDEAä¸­é‡æ–°å¯åŠ¨ `RuoYiApplication`
- æ£€æŸ¥å¯åŠ¨æ—¥å¿—ï¼Œç¡®è®¤æ— é”™è¯¯
- ç¡®è®¤Rediså·²å¯åŠ¨

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯•1ï¼šå¥åº·æ£€æŸ¥ âœ…

**ç›®çš„**: ç¡®è®¤æµ‹è¯•æ¥å£å’Œä¾èµ–éƒ½å·²åŠ è½½

**è¯·æ±‚**:
```bash
GET http://localhost:8080/crypto/test/smart-batch/health
```

**é¢„æœŸç»“æœ**:
```json
{
  "code": 200,
  "msg": "æ“ä½œæˆåŠŸ",
  "data": {
    "status": "healthy",
    "consistentHashUtil": "initialized",
    "smartBatchService": "initialized",
    "currentConsumers": 0,
    "timestamp": 1731331200000
  }
}
```

---

### æµ‹è¯•2ï¼šä¸€è‡´æ€§å“ˆå¸ŒåŠŸèƒ½ âœ…

**ç›®çš„**: éªŒè¯ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æ˜¯å¦æ­£å¸¸å·¥ä½œ

**æ­¥éª¤1**: è®¾ç½®Consumeråˆ—è¡¨
```bash
POST http://localhost:8080/crypto/test/smart-batch/consumers/set
Content-Type: application/json

["consumer-1", "consumer-2", "consumer-3"]
```

**é¢„æœŸç»“æœ**:
```json
{
  "code": 200,
  "msg": "æ“ä½œæˆåŠŸ",
  "data": {
    "message": "Consumeråˆ—è¡¨æ›´æ–°æˆåŠŸ",
    "consumers": ["consumer-1", "consumer-2", "consumer-3"],
    "count": 3
  }
}
```

**æ­¥éª¤2**: æµ‹è¯•CAåˆ†é…
```bash
GET http://localhost:8080/crypto/test/smart-batch/consistent-hash/test?consumers=consumer-1,consumer-2&cas=0x123abc,0x456def,0x789ghi,0xabc123,0xdef456
```

**é¢„æœŸç»“æœ**:
```json
{
  "code": 200,
  "msg": "æ“ä½œæˆåŠŸ",
  "data": {
    "consumers": ["consumer-1", "consumer-2"],
    "cas": ["0x123abc", "0x456def", "0x789ghi", "0xabc123", "0xdef456"],
    "fixedBucketCount": 256,
    "virtualNodes": 150,
    "caToConsumer": {
      "0x123abc": "consumer-1 (bucket:45)",
      "0x456def": "consumer-2 (bucket:123)",
      "0x789ghi": "consumer-1 (bucket:67)",
      "0xabc123": "consumer-2 (bucket:189)",
      "0xdef456": "consumer-1 (bucket:234)"
    },
    "groupedByConsumer": {
      "consumer-1": ["0x123abc", "0x789ghi", "0xdef456"],
      "consumer-2": ["0x456def", "0xabc123"]
    },
    "bucketDistribution": {
      "consumer-1": 128,
      "consumer-2": 128
    }
  }
}
```

**éªŒè¯ç‚¹**:
- âœ… å›ºå®šæ§½æ•°ä¸º256
- âœ… è™šæ‹ŸèŠ‚ç‚¹æ•°ä¸º150
- âœ… CAå‡åŒ€åˆ†é…åˆ°Consumer
- âœ… æ§½ä½åˆ†å¸ƒåŸºæœ¬å‡è¡¡ï¼ˆæ¯ä¸ªConsumerçº¦128ä¸ªæ§½ä½ï¼‰

---

### æµ‹è¯•3ï¼šæ™ºèƒ½ç›®æ ‡åŒæ­¥å’Œæ‰¹æ¬¡åˆ†é… â­ **æ ¸å¿ƒæµ‹è¯•**

**ç›®çš„**: éªŒè¯æ™ºèƒ½æ‰¹æ¬¡åˆ†é…çš„å®Œæ•´æµç¨‹

**æ­¥éª¤1**: å…ˆè®¾ç½®Consumeråˆ—è¡¨ï¼ˆå¦‚æœè¿˜æ²¡è®¾ç½®ï¼‰
```bash
POST http://localhost:8080/crypto/test/smart-batch/consumers/set
Content-Type: application/json

["consumer-1", "consumer-2"]
```

**æ­¥éª¤2**: æ‰§è¡Œæ™ºèƒ½ç›®æ ‡åŒæ­¥
```bash
POST http://localhost:8080/crypto/test/smart-batch/task/100/sync
```
**æ³¨æ„**: æ›¿æ¢ `100` ä¸ºä½ åˆ›å»ºçš„æµ‹è¯•ä»»åŠ¡ID

**é¢„æœŸç»“æœ**:
```json
{
  "code": 200,
  "msg": "æ“ä½œæˆåŠŸ",
  "data": {
    "success": true,
    "addedTargets": 6153,
    "removedTargets": 0,
    "totalTargets": 6153,
    "allocatedBatches": 63,
    "newEpoch": 1,
    "duration": "4523ms"
  }
}
```

**éªŒè¯ç‚¹**:
- âœ… `success: true` - åŒæ­¥æˆåŠŸ
- âœ… `addedTargets` - æ–°å¢çš„ç›®æ ‡æ•°é‡
- âœ… `totalTargets` - æ€»ç›®æ ‡æ•°é‡ï¼ˆåº”è¯¥<=10000ï¼Œå—maxTargetsé™åˆ¶ï¼‰
- âœ… `allocatedBatches` - åˆ†é…çš„æ‰¹æ¬¡æ•°ï¼ˆçº¦ totalTargets / 99ï¼‰
- âœ… `newEpoch: 1` - ç¬¬ä¸€æ¬¡åˆ†é…ï¼Œepochä¸º1
- âœ… `duration` - æ‰§è¡Œè€—æ—¶ï¼ˆ6000ä¸ªç›®æ ‡çº¦4-5ç§’ï¼‰

**æ­¥éª¤3**: æ£€æŸ¥æ•°æ®åº“

```sql
-- 3.1 æ£€æŸ¥ä»»åŠ¡çš„current_epoch
SELECT id, task_name, current_epoch FROM monitor_task_v2 WHERE id = 100;
-- é¢„æœŸ: current_epoch = 1

-- 3.2 æ£€æŸ¥ç›®æ ‡æ•°é‡
SELECT COUNT(*) FROM monitor_task_target_v2 WHERE task_id = 100;
-- é¢„æœŸ: ä¸APIè¿”å›çš„totalTargetsä¸€è‡´

-- 3.3 æ£€æŸ¥æ‰¹æ¬¡æ•°é‡
SELECT COUNT(*) FROM monitor_batch_v2 WHERE task_id = 100 AND epoch = 1;
-- é¢„æœŸ: ä¸APIè¿”å›çš„allocatedBatchesä¸€è‡´

-- 3.4 æ£€æŸ¥æ‰¹æ¬¡è¯¦æƒ…
SELECT 
    consumer_id,
    COUNT(*) as batch_count,
    SUM(target_count) as total_targets
FROM monitor_batch_v2
WHERE task_id = 100 AND epoch = 1
GROUP BY consumer_id;
-- é¢„æœŸ: ç›®æ ‡å‡åŒ€åˆ†é…åˆ°å„Consumer

-- 3.5 æ£€æŸ¥æ‰¹æ¬¡é¡¹æ•°é‡
SELECT COUNT(*) FROM monitor_batch_item_v2 
WHERE task_id = 100;
-- é¢„æœŸ: ä¸totalTargetsä¸€è‡´

-- 3.6 æ£€æŸ¥æ‰¹æ¬¡é¡¹çŠ¶æ€
SELECT status, COUNT(*) FROM monitor_batch_item_v2
WHERE task_id = 100
GROUP BY status;
-- é¢„æœŸ: å…¨éƒ¨ä¸º 'pending'
```

---

### æµ‹è¯•4ï¼šEpochç‰ˆæœ¬æ›´æ–° + è‡ªåŠ¨æ¸…ç† â­ **é‡è¦æµ‹è¯•**

**ç›®çš„**: éªŒè¯é›¶åœæœºæ›´æ–°ã€è‡ªåŠ¨åˆ é™¤æ—§æ‰¹æ¬¡ï¼ˆæ”¯æŒé‡å¤æ‰§è¡Œï¼‰

**æ­¥éª¤1**: å†æ¬¡æ‰§è¡ŒåŒæ­¥ï¼ˆæ¨¡æ‹Ÿç›®æ ‡å˜æ›´ï¼‰
```bash
POST http://localhost:8080/crypto/test/smart-batch/task/100/sync
```

**é¢„æœŸç»“æœ**:
```json
{
  "code": 200,
  "msg": "æ“ä½œæˆåŠŸ",
  "data": {
    "success": true,
    "addedTargets": 0,      // æ²¡æœ‰æ–°ç›®æ ‡
    "removedTargets": 0,    // æ²¡æœ‰ç§»é™¤ç›®æ ‡
    "totalTargets": 6153,
    "allocatedBatches": 63,
    "newEpoch": 2,          // â­ epoché€’å¢
    "duration": "3821ms"
  }
}
```

**æ­¥éª¤2**: æ£€æŸ¥æ•°æ®åº“

```sql
-- 2.1 æ£€æŸ¥ä»»åŠ¡çš„current_epoch
SELECT id, task_name, current_epoch FROM monitor_task_v2 WHERE id = 100;
-- é¢„æœŸ: current_epoch = 2 â­

-- 2.2 æ£€æŸ¥æ˜¯å¦åªæœ‰æœ€æ–°epochçš„æ‰¹æ¬¡
SELECT epoch, COUNT(*) as batch_count, SUM(target_count) as total_targets
FROM monitor_batch_v2
WHERE task_id = 100
GROUP BY epoch;
-- é¢„æœŸ: åªæœ‰ epoch = 2 çš„æ‰¹æ¬¡ï¼ˆæ—§æ‰¹æ¬¡å·²è¢«è‡ªåŠ¨åˆ é™¤ï¼‰â­

-- 2.3 éªŒè¯æ‰¹æ¬¡é¡¹ä¹Ÿè¢«æ¸…ç†
SELECT COUNT(*) FROM monitor_batch_item_v2 WHERE task_id = 100;
-- é¢„æœŸ: 6153æ¡ï¼ˆåªæœ‰å½“å‰epochçš„æ‰¹æ¬¡é¡¹ï¼‰â­

-- 2.4 éªŒè¯ç›®æ ‡è¡¨æ•°æ®æ­£å¸¸
SELECT COUNT(*) FROM monitor_task_target_v2 WHERE task_id = 100;
-- é¢„æœŸ: 6153æ¡ï¼ˆç›®æ ‡è¡¨ä¸å—å½±å“ï¼‰â­
```

**æ­¥éª¤3**: ğŸ¯ **é‡å¤æ‰§è¡Œæµ‹è¯•ï¼ˆéªŒè¯æ”¯æŒé‡å¤æ‰§è¡Œï¼‰**

```bash
# è¿ç»­æ‰§è¡Œ3æ¬¡åŒæ­¥
POST http://localhost:8080/crypto/test/smart-batch/task/100/sync
POST http://localhost:8080/crypto/test/smart-batch/task/100/sync
POST http://localhost:8080/crypto/test/smart-batch/task/100/sync
```

**é¢„æœŸç»“æœ**:
```sql
-- æ¯æ¬¡æ‰§è¡Œåï¼Œcurrent_epoché€’å¢
SELECT id, task_name, current_epoch FROM monitor_task_v2 WHERE id = 100;
-- é¢„æœŸ: current_epoch = 5 â­

-- æ¯æ¬¡æ‰§è¡Œåï¼Œåªä¿ç•™æœ€æ–°epochçš„æ‰¹æ¬¡
SELECT epoch, COUNT(*) as batch_count
FROM monitor_batch_v2
WHERE task_id = 100
GROUP BY epoch;
-- é¢„æœŸ: åªæœ‰ epoch = 5 çš„æ‰¹æ¬¡ï¼ˆæ—§æ‰¹æ¬¡å…¨éƒ¨è‡ªåŠ¨åˆ é™¤ï¼‰â­
```

**éªŒè¯ç‚¹**:
- âœ… Epochæ­£ç¡®é€’å¢ï¼ˆ2 â†’ 3 â†’ 4 â†’ 5ï¼‰
- âœ… æ—§æ‰¹æ¬¡è‡ªåŠ¨åˆ é™¤ï¼ˆé¿å…å”¯ä¸€ç´¢å¼•å†²çªï¼‰
- âœ… æ”¯æŒé‡å¤æ‰§è¡Œï¼ˆä¸ä¼šå› ä¸ºå”¯ä¸€ç´¢å¼•å†²çªè€Œå¤±è´¥ï¼‰
- âœ… æ•°æ®ä¸€è‡´æ€§ï¼ˆå…ˆåˆ æ‰¹æ¬¡é¡¹ï¼Œå†åˆ æ‰¹æ¬¡ï¼‰

---

## ğŸ¯ æ€§èƒ½æµ‹è¯•

### æµ‹è¯•åœºæ™¯ï¼š6000ä¸ªç›®æ ‡

**é…ç½®**:
- `monitor.batch.max-targets: 10000`
- `monitor.batch.batch-size: 99`
- Consumeræ•°é‡: 2

**é¢„æœŸæ€§èƒ½**:
- åŒæ­¥è€—æ—¶: 4-6ç§’
- åˆ†é…æ‰¹æ¬¡æ•°: ~61æ‰¹æ¬¡
- Redisé”è¶…æ—¶: 420ç§’ï¼ˆ5åˆ†é’ŸåŸºç¡€ + 120ç§’ï¼‰

**å®é™…æµ‹è¯•**:
```bash
POST http://localhost:8080/crypto/test/smart-batch/task/100/sync
```

**è®°å½•ç»“æœ**:
- [ ] åŒæ­¥è€—æ—¶: ______ ms
- [ ] åˆ†é…æ‰¹æ¬¡æ•°: ______
- [ ] Redisé”è·å–: æˆåŠŸ / å¤±è´¥
- [ ] æ•°æ®åº“æ’å…¥: æˆåŠŸ / å¤±è´¥

---

## âš ï¸ å¸¸è§é—®é¢˜

### 1. è·å–Redisé”å¤±è´¥
**é”™è¯¯**: `"è·å–åˆ†å¸ƒå¼é”å¤±è´¥ï¼Œå¯èƒ½æœ‰å…¶ä»–åŒæ­¥ä»»åŠ¡æ­£åœ¨æ‰§è¡Œ"`

**åŸå› **: 
- ä¸Šä¸€æ¬¡åŒæ­¥è¿˜æ²¡å®Œæˆ
- Redisè¿æ¥å¤±è´¥

**è§£å†³**:
- ç­‰å¾…å‡ åˆ†é’Ÿåé‡è¯•
- æ£€æŸ¥Redisæ˜¯å¦æ­£å¸¸è¿è¡Œ
- æŸ¥çœ‹Redisé”çŠ¶æ€: `GET smart_batch:task:100`

### 2. ä»»åŠ¡ä¸å­˜åœ¨
**é”™è¯¯**: `"ä»»åŠ¡ä¸å­˜åœ¨"`

**åŸå› **: taskIdé”™è¯¯

**è§£å†³**: 
```sql
SELECT id, task_name, task_type, status FROM monitor_task_v2;
```

### 3. ä»»åŠ¡æœªå¯ç”¨
**é”™è¯¯**: `"ä»»åŠ¡æœªå¯ç”¨"`

**åŸå› **: ä»»åŠ¡çŠ¶æ€ä¸æ˜¯1

**è§£å†³**:
```sql
UPDATE monitor_task_v2 SET status = 1 WHERE id = 100;
```

### 4. æ²¡æœ‰ç›®æ ‡ç­›é€‰å‡ºæ¥
**é”™è¯¯**: `addedTargets: 0, totalTargets: 0`

**åŸå› **: 
- `token_launch_history`è¡¨ä¸ºç©º
- é“¾ç±»å‹ä¸åŒ¹é…
- maxTargetsé…ç½®å¤ªå°

**è§£å†³**:
```sql
-- æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
SELECT COUNT(*) FROM token_launch_history WHERE chain_type = 'sol';

-- æ£€æŸ¥é…ç½®
SELECT * FROM monitor_task_v2 WHERE id = 100;
```

---

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] å¥åº·æ£€æŸ¥é€šè¿‡
- [ ] ä¸€è‡´æ€§å“ˆå¸ŒåŠŸèƒ½æ­£å¸¸
- [ ] Consumeråˆ—è¡¨å¯ä»¥æ­£å¸¸è®¾ç½®
- [ ] æ™ºèƒ½ç›®æ ‡åŒæ­¥æˆåŠŸ
- [ ] æ‰¹æ¬¡å’Œæ‰¹æ¬¡é¡¹æ­£ç¡®åˆ›å»º
- [ ] Epochç‰ˆæœ¬æ­£ç¡®é€’å¢
- [ ] æ—§epochæ‰¹æ¬¡è‡ªåŠ¨åˆ é™¤ï¼ˆæ”¯æŒé‡å¤æ‰§è¡Œï¼‰
- [ ] Redisåˆ†å¸ƒå¼é”æ­£å¸¸å·¥ä½œ
- [ ] WebSocketé€šçŸ¥å‘é€ï¼ˆæ£€æŸ¥æ—¥å¿—ï¼‰
- [ ] æ€§èƒ½ç¬¦åˆé¢„æœŸï¼ˆ6000ä¸ªç›®æ ‡<6ç§’ï¼‰

---

## ğŸ§¹ æµ‹è¯•åæ¸…ç†

### åˆ é™¤æµ‹è¯•æ•°æ®
```sql
-- åˆ é™¤æµ‹è¯•ä»»åŠ¡ç›¸å…³æ•°æ®
DELETE FROM monitor_batch_item_v2 WHERE task_id = 100;
DELETE FROM monitor_batch_v2 WHERE task_id = 100;
DELETE FROM monitor_task_target_v2 WHERE task_id = 100;
DELETE FROM monitor_task_v2 WHERE id = 100;
```

### æ¸…ç†Redisé”ï¼ˆå¦‚æœéœ€è¦ï¼‰
```bash
redis-cli DEL "smart_batch:task:100"
```

---

## ğŸ“Š æµ‹è¯•æŠ¥å‘Šæ¨¡æ¿

```
æµ‹è¯•æ—¥æœŸ: 2025-11-11
æµ‹è¯•äººå‘˜: ______
æµ‹è¯•ç¯å¢ƒ: å¼€å‘ç¯å¢ƒ

ã€æµ‹è¯•ç»“æœã€‘
- å¥åº·æ£€æŸ¥: âœ… / âŒ
- ä¸€è‡´æ€§å“ˆå¸Œ: âœ… / âŒ
- æ™ºèƒ½ç›®æ ‡åŒæ­¥: âœ… / âŒ
- Epochç‰ˆæœ¬æ›´æ–°: âœ… / âŒ
- è‡ªåŠ¨æ¸…ç†æ—§æ‰¹æ¬¡: âœ… / âŒ
- é‡å¤æ‰§è¡Œæµ‹è¯•: âœ… / âŒ
- æ€§èƒ½æµ‹è¯•: âœ… / âŒ

ã€æ€§èƒ½æ•°æ®ã€‘
- ç›®æ ‡æ•°é‡: ______
- åŒæ­¥è€—æ—¶: ______ ms
- åˆ†é…æ‰¹æ¬¡: ______
- Consumeræ•°é‡: ______

ã€é—®é¢˜è®°å½•ã€‘
1. ______
2. ______

ã€ç»“è®ºã€‘
âœ… é€šè¿‡æµ‹è¯•ï¼Œå¯ä»¥ä¸Šçº¿
âŒ å­˜åœ¨é—®é¢˜ï¼Œéœ€è¦ä¿®å¤
```

---

**å‡†å¤‡å¥½å¼€å§‹æµ‹è¯•äº†å—ï¼Ÿ**ğŸš€

